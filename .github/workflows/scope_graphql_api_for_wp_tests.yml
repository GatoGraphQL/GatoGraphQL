name: Scope GraphQL API for WP tests
on:
    push:
        branches:
            - master
    pull_request: null

env:
    # see https://github.com/composer/composer/issues/9368#issuecomment-718112361
    COMPOSER_ROOT_VERSION: "dev-master"

jobs:
    main:
        defaults:
            run:
                working-directory: layers/GraphQLAPIForWP/plugins/graphql-api-for-wp
        name: Scope the plugin code via PHP-Scoper, and execute tests
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@v2

                # see https://github.com/shivammathur/setup-php
            -   name: Set-up PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: 7.4
                    coverage: none
                env:
                    COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            -   name: Install root dependencies
                uses: "ramsey/composer-install@v1"

            # "custom-bump-interdependency" temporarily needed because of bug:
            # https://github.com/symplify/symplify/issues/2773
            -   name: Localize package paths
                run: |
                    vendor/bin/monorepo-builder custom-bump-interdependency "dev-master"
                    vendor/bin/monorepo-builder localize-composer-paths layers/GraphQLAPIForWP/plugins/graphql-api-for-wp/composer.json --ansi
                working-directory: .

            -   name: Install plugin dependencies for PROD
                run: composer install --no-dev --no-progress --no-interaction --ansi

            -   name: Install PHP-Scoper
                run: |
                    composer global config minimum-stability dev
                    composer global config prefer-stable true
                    composer global require humbug/php-scoper

            # Notice that the scoped results correspond to vendor/, so must manually generate them in such folder
            -   name: Scope plugin into separate folder
                run: php-scoper add-prefix --output-dir build-prefixed/vendor --ansi

            -   name: Copy scoped code back into plugin
                run: rsync --recursive build-prefixed/ layers/GraphQLAPIForWP/plugins/graphql-api-for-wp/
                working-directory: .

            -   name: Regenerate autoloader
                run: composer dumpautoload --optimize --classmap-authoritative --ansi

            -   name: Install Rector (globally)
                run: composer global require rector/rector

            -   name: Run Rector on the scoped code
                run: rector process --config=rector-test-scoping.php --ansi

