"use strict";!function(e){window.popUserAccount={sessions:{},initDocument:function(e){var n=this,s=e.domain;n.initialLogin(s)},initDomain:function(e){var n=this,s=e.domain;n.sessions[s]={initialuserdata:!0,loggedin:!1,id:null,name:"",avatar:"",url:"",roles:[],userattributes:[]}},documentInitialized:function(e){var n=this;e.domain;n.checkpointInvalidateBlocks()},documentLoaded:function(){this.fetchAllDomainsLoggedInUserData()},pageSectionInitialized:function(e){var n=this;e.pageSection.on("fetched",function(e,s,i,t){n.feedbackLoginOut(t,!1)})},blockInitialized:function(e){var n=this;e.pageSection;e.block.on("fetched",function(e,s,i,t){n.feedbackLoginOut(t,!1)})},loadAvatar:function(e){var n=this,s=e.domain;e.targets.attr("src",n.sessions[s].avatar)},initialLogin:function(e){var n=this,s=n.feedbackLoginOut(e,!0);n.sessions[e].initialuserdata=!s},fetchAllDomainsLoggedInUserData:function(n){var s=this;e.each(M.USERLOGGEDIN_DATA_PAGEURLS,function(e,i){var t=getDomain(i);s.sessions[t].initialuserdata&&s.fetchLoggedInUserData(i,n)})},fetchLoggedInUserData:function(e,n){(n=n||{})["loadingmsg-target"]=M.USERLOGGEDIN_LOADINGMSG_TARGET,n.silentDocument=!0,popManager.fetch(e,n)},isLoggedInAnyDomain:function(){var n=this,s=!1;return e.each(n.sessions,function(e,n){if(n.loggedin)return s=!0,-1}),s},isLoggedIn:function(e){return this.sessions[e].loggedin},updateUserInfo:function(n,s,i,t,o,a,r){var d=this,u={},c=getDomainId(n);d.sessions[n].name!=i&&(d.sessions[n].name=i,e(".pop-user-name."+c).text(i),u.name=i),d.sessions[n].id==s&&d.sessions[n].avatar==t||(d.sessions[n].id=s,d.sessions[n].avatar=t,e(".pop-user-avatar."+c).attr("src",t),u.avatar=t),d.sessions[n].url!=o&&(d.sessions[n].url=o,e(".pop-user-url."+c).attr("href",o),u.url=o),0===e(d.sessions[n].roles).not(a).length&&0===e(a).not(d.sessions[n].roles).length||(d.sessions[n].roles=a,e.each(M.ROLES,function(n,s){e(document.body).removeClass(s+"-"+c)}),e.each(d.sessions[n].roles,function(n,s){e(document.body).addClass(s+"-"+c)}),u.roles=a),0===e(d.sessions[n].userattributes).not(r).length&&0===e(r).not(d.sessions[n].userattributes).length||(d.sessions[n].userattributes=r,e.each(M.USERATTRIBUTES,function(n,s){e(document.body).removeClass(s+"-"+c)}),e.each(d.sessions[n].userattributes,function(n,s){e(document.body).addClass(s+"-"+c)}),u.userattributes=r),e.isEmptyObject(u)||(u.id=s,e(document).triggerHandler("user:updated",[u,n]),e(document).triggerHandler("user:updated:"+n,[u]))},loginout:function(n,s,i,t,o,a,r,d,u){var c=this;if(c.updateUserInfo(s,t,o,a,r,d,u),c.sessions[s].loggedin!=i){c.sessions[s].loggedin=i;var g=[];s==M.HOME_DOMAIN&&g.push("loggedin-localdomain");var o,l=e(document.body),f=getDomainId(s);c.sessions[s].loggedin?(g.push("loggedin-anydomain"),l.data("loggedinuser-id-"+f,t).addClass("loggedin-"+f+" user-"+t+"-"+f),e.each(g,function(e,n){l.addClass(n)}),o="user:loggedin"):(c.isLoggedInAnyDomain()||g.push("loggedin-anydomain"),l.removeClass("loggedin-"+f).removeClass("user-"+l.data("loggedinuser-id-"+f)+"-"+f).data("loggedinuser-id-"+f,""),e.each(g,function(e,n){l.removeClass(n)}),o="user:loggedout"),"initialfeedback"!=n&&c.closeCheckpointMessages(s),e(document).triggerHandler(o,[n,s]),e(document).triggerHandler(o+":"+s,[n]),e(document).triggerHandler("user:loggedinout",[n,s]),e(document).triggerHandler("user:loggedinout:"+s,[n])}},feedbackLoginOut:function(e,n){var s=this,i=popManager.getTopLevelFeedback(e)[M.DATALOAD_USER];if(void 0!==i){var t,o,a,r,d,u,c;t=i[M.DATALOAD_USER_LOGGEDIN],o=i[M.DATALOAD_USER_ID],a=i[M.DATALOAD_USER_NAME],r=i[M.DATALOAD_USER_AVATAR],d=i[M.DATALOAD_USER_URL],u=i[M.DATALOAD_USER_ROLES],c=i[M.DATALOAD_USER_ATTRIBUTES];var g="feedback";return n?g="initialfeedback":s.sessions[e].initialuserdata&&(g="initialuserdata",s.sessions[e].initialuserdata=!1),s.loginout(g,e,t,o,a,r,d,u,c),!0}return!1},checkpointInvalidateBlocks:function(){var n=this;e(document).on("user:loggedin",function(e,s,i){"initialfeedback"!=s&&"initialuserdata"!=s&&n.closeCheckpointMessages(i)})},closeCheckpointMessages:function(e){jQuery(document).ready(function(n){n(".alert.in.pop-messagefeedback.checkpoint."+getDomainId(e)).removeClass("fade").alert("close")})},getLoggedInUserId:function(e){var n=this;return!(!n.sessions[e]||!n.sessions[e].loggedin)&&n.sessions[e].id}}}(jQuery),popJSLibraryManager.register(popUserAccount,["initDocument","initDomain","documentInitialized","documentLoaded","pageSectionInitialized","blockInitialized","loadAvatar"]);