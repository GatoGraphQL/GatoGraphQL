"use strict";!function(e){window.popUserAccount={sessions:{},initDocument:function(e){var n=this,i=e.domain;n.initialLogin(i)},initDomain:function(e){var n=this,i=e.domain;n.sessions[i]=n.getInitialSessionObject()},documentInitialized:function(e){var n=this;e.domain;n.checkpointInvalidateBlocks()},documentLoaded:function(){this.fetchAllDomainsLoggedInUserData()},pageSectionInitialized:function(e){var n=this;e.pageSection.on("fetched",function(e,i,t,o){n.feedbackLoginOut(o,!1)})},blockInitialized:function(e){var n=this;e.pageSection;e.block.on("fetched",function(e,i,t,o){n.feedbackLoginOut(o,!1)})},getInitialSessionObject:function(){var e={object:{initialuserdata:!0,loggedin:!1,id:null,name:"",url:""}};return popJSLibraryManager.execute("getUserAccountInitialSessionObject",e),e.object},initialLogin:function(e){var n=this,i=n.feedbackLoginOut(e,!0);n.sessions[e].initialuserdata=!i},fetchAllDomainsLoggedInUserData:function(n){var i=this;e.each(M.USERLOGGEDIN_DATA_PAGEURLS,function(e,t){var o=getDomain(t);i.sessions[o].initialuserdata&&i.fetchLoggedInUserData(t,n)})},fetchLoggedInUserData:function(e,n){(n=n||{})["loadingmsg-target"]=M.USERLOGGEDIN_LOADINGMSG_TARGET,n.silentDocument=!0,popManager.fetch(e,n)},isLoggedInAnyDomain:function(){var n=this,i=!1;return e.each(n.sessions,function(e,n){if(n.loggedin)return i=!0,-1}),i},isLoggedIn:function(e){return this.sessions[e].loggedin},updateUserInfo:function(n,i){var t,o,s,a=this,d={},r=getDomainId(n);t=i[M.DATALOAD_USER_ID],o=i[M.DATALOAD_USER_NAME],s=i[M.DATALOAD_USER_URL],a.sessions[n].name!=o&&(a.sessions[n].name=o,e(".pop-user-name."+r).text(o),d.name=o),a.sessions[n].url!=s&&(a.sessions[n].url=s,e(".pop-user-url."+r).attr("href",s),d.url=s);var u={domain:n,userInfo:i,updates:d};popJSLibraryManager.execute("updateUserAccountInfo",u),d=u.updates,e.isEmptyObject(d)||(d.id=t,e(document).triggerHandler("user:updated",[d,n]),e(document).triggerHandler("user:updated:"+n,[d]))},loginout:function(n,i,t){var o=this;o.updateUserInfo(i,t);var s=t[M.DATALOAD_USER_LOGGEDIN];if(o.sessions[i].loggedin!=s){o.sessions[i].loggedin=s;var a=[];i==M.HOME_DOMAIN&&a.push("loggedin-localdomain");var d,r=e(document.body),u=getDomainId(i);if(o.sessions[i].loggedin){a.push("loggedin-anydomain");var c=t[M.DATALOAD_USER_ID];r.data("loggedinuser-id-"+u,c).addClass("loggedin-"+u+" user-"+c+"-"+u),e.each(a,function(e,n){r.addClass(n)}),d="user:loggedin"}else o.isLoggedInAnyDomain()||a.push("loggedin-anydomain"),r.removeClass("loggedin-"+u).removeClass("user-"+r.data("loggedinuser-id-"+u)+"-"+u).data("loggedinuser-id-"+u,""),e.each(a,function(e,n){r.removeClass(n)}),d="user:loggedout";"initialfeedback"!=n&&o.closeCheckpointMessages(i),e(document).triggerHandler(d,[n,i]),e(document).triggerHandler(d+":"+i,[n]),e(document).triggerHandler("user:loggedinout",[n,i]),e(document).triggerHandler("user:loggedinout:"+i,[n])}},feedbackLoginOut:function(e,n){var i=this,t=popManager.getTopLevelFeedback(e)[M.DATALOAD_USER];if(void 0!==t){var o="feedback";return n?o="initialfeedback":i.sessions[e].initialuserdata&&(o="initialuserdata",i.sessions[e].initialuserdata=!1),i.loginout(o,e,t),!0}return!1},checkpointInvalidateBlocks:function(){var n=this;e(document).on("user:loggedin",function(e,i,t){"initialfeedback"!=i&&"initialuserdata"!=i&&n.closeCheckpointMessages(t)})},closeCheckpointMessages:function(e){jQuery(document).ready(function(n){n(".alert.in.pop-messagefeedback.checkpoint."+getDomainId(e)).removeClass("fade").alert("close")})},getLoggedInUserId:function(e){var n=this;return!(!n.sessions[e]||!n.sessions[e].loggedin)&&n.sessions[e].id}}}(jQuery),popJSLibraryManager.register(popUserAccount,["initDocument","initDomain","documentInitialized","documentLoaded","pageSectionInitialized","blockInitialized"]);