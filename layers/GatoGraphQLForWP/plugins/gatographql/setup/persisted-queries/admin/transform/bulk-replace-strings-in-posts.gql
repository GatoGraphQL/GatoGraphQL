########################################################################
#
# This Persisted GraphQL query adapts content in bulk, updating the
# title, content and excerpt for multiple posts with a single request.
#
# *********************************************************************
# 
# URL params:
#   - limit: Number of posts to update
#   - offset: Position of the first post to update
#   - replaceFrom: The list of strings to search
#   - replaceTo: The list of strings to replace with
# 
# *********************************************************************
#
# More info:
#   - https://gatographql.com/recipes/adapting-content-in-bulk/
#
########################################################################

query TransformAndExportData(
  $limit: Int! = 5,
  $offset: Int! = 0,
  $replaceFrom: [String!]!
  $replaceTo: [String!]!
) {
  posts: posts(
    pagination: { limit: $limit, offset: $offset }
    sort: { by: ID, order: ASC }
  ) {
    title
    excerpt
      @strReplaceMultiple(
        search: $replaceFrom
        replaceWith: $replaceTo
        affectAdditionalFieldsUnderPos: 1
      )
      @deferredExport(
        as: "postInputs"
        type: DICTIONARY
        affectAdditionalFieldsUnderPos: 1
      )
  }
}

mutation UpdatePost(
  $limit: Int! = 5,
  $offset: Int! = 0
)
  @depends(on: "TransformAndExportData")
{
  adaptedPosts: posts(
    pagination: { limit: $limit, offset: $offset }
    sort: { by: ID, order: ASC }
  ) {
    id
    postInput: _objectProperty(
      object: $postInputs,
      by: { key: $__id }
    ) @remove
    update(input: $__postInput) {
      status
      errors {
        __typename
        ...on ErrorPayload {
          message
        }
      }
      post {
        title
        excerpt
      }
    }
  }
}