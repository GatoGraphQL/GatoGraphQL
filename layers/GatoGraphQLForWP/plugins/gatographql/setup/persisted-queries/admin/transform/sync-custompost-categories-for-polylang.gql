########################################################################
# 
# Variables:
#   - customPostId: The custom post with the origin language, from where to trigger the updates
#   - customPostType: The custom post's type. Default is `post`
#   - categoryTaxonomy: The taxonomy of the categories. Default is `category`
#   - statusToUpdate: The status that the translation posts must have to be updated. It is `draft` by default. Pass `any` for any status.
#   - triggerUpdateFromDefaultLanguageOnly: Indicate if to only execute the update when the origin post has the default language of the site. It is `true` by default.
#
# *********************************************************************
#
# === Description ===
#
# This Persisted GraphQL query is an integration for Polylang.
#
# It takes an origin post, queries its categories,
# and updates its translation posts with the corresponding
# categories for the corresponding language,
# as set-up via Polylang. If some category does not
# have a translation, that category is removed.
#
# All translation posts must have the `draft` status
# to be updated. To update posts with any other status, use
# variable `$statusToUpdate` (for instance, passing value
# `publish`, `pending` or `any`)
#
# By default, the origin post must have the default language
# of the site, or the update will not be executed.
# To trigger the update from any language, pass variable
# `$triggerUpdateFromDefaultLanguageOnly` with `false`.
#
########################################################################
query InitializeVariables
  @configureWarningsOnExportingDuplicateVariable(enabled: false)
{
  emptyString: _echo(value: null)
    @export(as: "fromLanguage")

  emptyBool: _echo(value: false)
    @export(as: "executeUpdate")
    @export(as: "hasOriginCustomPostTranslationPosts")
  
  emptyArray: _echo(value: [])
    @export(as: "originCustomPostTranslationPostIds")
    @export(as: "originCustomPostCategoryIDs")
  
  emptyJSON: _echo(value: {})
    @export(as: "categoryIDTranslationLanguageIDs")
}

query ExportDataFromOriginCustomPost(
  $customPostId: ID!
  $categoryTaxonomy: CategoryTaxonomyEnumString! = "category"
)
  @depends(on: "InitializeVariables")
{
  defaultLanguage: polylangDefaultLanguage {
    code @export(as: "defaultLanguage")
  }

  languages: polylangLanguages {
    code @export(
      as: "languageLocaleCodes"
      type: DICTIONARY
    )
  }

  originCustomPost: customPost(by: { id: $customPostId }, status: any) {
    __typename
    ...on CustomPost {
      id
      
      polylangLanguage {
        code @export(as: "fromLanguage")
      }
      
      polylangTranslationLanguageIDs
        @remove
      customPostIDTranslationLanguageIDs: _echo(value: $__polylangTranslationLanguageIDs)
        @default(value: {})
        @export(as: "customPostIDTranslationLanguageIDs")

      hasTranslationCustomPosts: _notEmpty(value: $__customPostIDTranslationLanguageIDs)
        @export(as: "hasOriginCustomPostTranslationPosts")
    }
    ...on Post {
      categories @export(as: "originCustomPostCategoryIDs") {
        ...CategoryData
      }
    }
    ...on GenericCustomPost {
      categories(taxonomy: $categoryTaxonomy) @export(as: "originCustomPostCategoryIDs") {
        ...CategoryData
      }
    }
  }
}

query ExportTranslationCustomPostLanguages(
  $statusToUpdate: CustomPostStatusEnum! = draft
  $customPostType: CustomPostEnumString! = "post"
)
  @depends(on: "ExportDataFromOriginCustomPost")
  @include(if: $hasOriginCustomPostTranslationPosts)
{
  originCustomPostTranslationPostIds: _objectValues(object: $customPostIDTranslationLanguageIDs)
    @export(as: "originCustomPostTranslationPostIds")
  translationCustomPostLanguages: customPosts(filter: { ids: $__originCustomPostTranslationPostIds, status: $statusToUpdate, customPostTypes: [$customPostType] } ) {
    __typename
    ...on CustomPost {
      id

      polylangLanguage @export(
        as: "translationCustomPostLanguages"
        type: DICTIONARY
      ) {
        code
      }
    }
  }
}

query FilterTranslationCustomPostsToUpdate(
  $statusToUpdate: CustomPostStatusEnum! = draft
  $customPostType: CustomPostEnumString! = "post"
  $triggerUpdateFromDefaultLanguageOnly: Boolean! = true
)
  @depends(on: "ExportTranslationCustomPostLanguages")
  @include(if: $hasOriginCustomPostTranslationPosts)
{
  translationCustomPosts: customPosts(filter: { ids: $originCustomPostTranslationPostIds, status: $statusToUpdate, customPostTypes: [$customPostType] } ) {
    __typename
    ...on CustomPost {
      id
      polylangLanguageCode: _objectProperty(
        object: $translationCustomPostLanguages,
        by: { key: $__id }
      )
      polylangLanguage: _objectProperty(
        object: $languageLocaleCodes,
        by: { key: $__polylangLanguageCode }
      )

      translationCustomPostCategoryIDs: _echo(value: $__polylangLanguage)
        @passOnwards(as: "lang")
        @applyField(
          name: "_echo"
          arguments: { value: $originCustomPostCategoryIDs }
          setResultInResponse: true
        )
        @underEachArrayItem(
          passValueOnwardsAs: "categoryID"
          affectDirectivesUnderPos: [1, 2]
        )
          @applyField(
            name: "_objectProperty"
            arguments: {
              object: $categoryIDTranslationLanguageIDs,
              by: { key: $categoryID }
            }
            passOnwardsAs: "categoryTranslationLanguageIDs"
          )
          @applyField(
            name: "_objectProperty"
            arguments: {
              object: $categoryTranslationLanguageIDs,
              by: { key: $lang },
              failIfNonExistingKeyOrPath: false
            }
            setResultInResponse: true
          )
        @arrayFilter
        @export(
          as: "translationCustomPostCategoryIDs",
          type: DICTIONARY
        )
        @remove
    }
  }

  hasTranslationCustomPosts: _notEmpty(value: $__translationCustomPosts)

  originCustomPostHasDefaultLanguage: _equals(
    value1: $defaultLanguage,
    value2: $fromLanguage
  )

  canTriggerUpdateFromOriginPost: _if(
    condition: $triggerUpdateFromDefaultLanguageOnly,
    then: $__originCustomPostHasDefaultLanguage,
    else: true
  )

  executeUpdate: _and(values: [
    $__hasTranslationCustomPosts,
    $__canTriggerUpdateFromOriginPost
  ])
    @export(as: "executeUpdate")
}

mutation UpdateCategoriesForTranslationPosts(
  $statusToUpdate: CustomPostStatusEnum! = draft
  $customPostType: CustomPostEnumString! = "post"
  $categoryTaxonomy: CategoryTaxonomyEnumString! = "category"
)
  @depends(on: "FilterTranslationCustomPostsToUpdate")
  @include(if: $executeUpdate)
{
  updateTranslationCustomPosts: customPosts(filter: { ids: $originCustomPostTranslationPostIds, status: $statusToUpdate, customPostTypes: [$customPostType] } ) {
    __typename
    ...on CustomPost {
      id
      polylangLanguage {
        code
      }

      categoryIDs: _objectProperty(
        object: $translationCustomPostCategoryIDs,
        by: { key: $__id }
      )
    }
    ...on Post {
      setCategories(input: {
        categoriesBy: {
          ids: $__categoryIDs
        },
        append: false
      }) {
        status
        errors {
          __typename
          ...on ErrorPayload {
            message
          }
        }
        post {
          categories {
            id
            name
            polylangLanguage {
              code
            }
          }
        }
      }
    }
    ...on GenericCustomPost {
      setCategories(input: {
        taxonomy: $categoryTaxonomy
        categoriesBy: {
          ids: $__categoryIDs
        },
        append: false
      }) {
        status
        errors {
          __typename
          ...on ErrorPayload {
            message
          }
        }
        customPost {
          __typename
          ...on CustomPost {
            categories(taxonomy: $categoryTaxonomy) {
              id
              name
              polylangLanguage {
                code
              }
            }
          }
        }
      }
    }
  }
}

fragment CategoryData on Category {
  id
  name
  polylangLanguage {
    code
  }
  polylangTranslationLanguageIDs
    @export(
      as: "categoryIDTranslationLanguageIDs",
      type: DICTIONARY
    )
}