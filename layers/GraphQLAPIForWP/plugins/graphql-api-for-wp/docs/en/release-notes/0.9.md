# Release Notes: 0.9

## GraphQL Schema Bonanza

The GraphQL schema mapping the WordPress data model has been completed! ðŸŽ‰

<!-- Add this image! -->
<!-- <a href="../../images/graphql-schema-v09.png" target="_blank">![GraphQL schema](../../images/graphql-schema-v09.png)</a> -->

Let's see what new elements have been added.

### Fetch entities by slug and path

The following fields have been added to the root:

- `Root.postBySlug: Post`
- `Root.postBySlugForAdmin: Post` ("admin" field)
- `Root.customPostBySlug: CustomPostUnion`
- `Root.customPostBySlugForAdmin: CustomPostUnion` ("admin" field)
- `Root.genericCustomPostBySlug: GenericCustomPost`
- `Root.genericCustomPostBySlugForAdmin: GenericCustomPost` ("admin" field)
- `Root.pageBySlug: Page`
- `Root.pageBySlugForAdmin: Page` ("admin" field)
- `Root.pageByPath: Page`
- `Root.pageByPathForAdmin: Page` ("admin" field)
- `Root.postCategoryBySlug: PostCategory`
- `Root.postTagBySlug: PostTag`
- `Root.mediaItemBySlug: MediaItem`

### Filter custom post fields by tag, category and author

On fields to retrieve custom posts, such as:

- `Root.posts`
- `Root.customPosts`
- `Root.genericCustomPosts`
- `Root.myPosts`
- `User.posts`
- `PostCategory.posts`
- `PostTag.posts`

...added field arguments for filtering the results:

- `tagIDs: [ID]`
- `tagSlugs: [String]`
- `categoryIDs: [ID]`
- `authorIDs: [ID]`
- `authorSlug: String`

For instance, this query retrieves posts containing either tag `"graphql"`, `"wordpress"` or `"plugin"`:

```graphql
{
  posts(tagSlugs: ["graphql", "wordpress", "plugin"]) {
    id
    title
  }
}
```

### Exclude results via field arg `excludeIDs`

Added the field argument `excludeIDs` on all fields retrieving posts and custom posts, media items, users, comments, tags, categories and menus.

```graphql
{
  posts(excludeIDs: [1, 2, 3]) {
    id
    title
  }
}
```

### Custom posts

Added fields to retrieve the logged-in user's custom posts:

- `Root.myCustomPost: CustomPostUnion`
- `Root.myCustomPosts: [CustomPostUnion]!`
- `Root.myCustomPostCount: Int!`

Added fields to all custom post entities (`Post`, `Page`, etc):

- `modified: String`
- `isSticky: Bool!`

### Posts

Added fields to the `Post` type:

- `postFormat: String!`

### Pages

Added fields to `Page` to fetch the parent and children, and the menu order:

- `parentPage: Page`
- `childPages: [Page]!`
- `childPageCount: Int!`
- `childPagesForAdmin: [Page]!`
- `childPageCountForAdmin: Int!`
- `menuOrder: Int!`

Filter field `pages` via new arguments:

- `parentIDs: [ID]`
- `parentID: ID`

```graphql
{
  pages(limit: 30, parentID: 0) {
    ...PageProps
    childPages(searchfor: "html") {
      ...PageProps
      childPages(limit: 3) {
        ...PageProps
      }
    }
  }
}

fragment PageProps on Page {
  id
  title
  date
  urlPath
}
```

### Comments

Added fields to retrieve comments and their number (and also their "admin" versions):

- `Root.comment: Comment`
- `Root.comments: [Comment]!`
- `Root.commentCount: Int!`
- `Root.myComment: Comment`
- `Root.myComments: [Comment]!`
- `Root.myCommentCount: Int!`
- `CustomPost.commentCount: Int!`
- `Comment.responseCount: Int!`

Added field arguments to filter `comments`:

- `authorIDs: [ID!]`
- `customPostID: ID!`
- `customPostIDs: [ID!]`
- `excludeCustomPostIDs: [ID]`
- `customPostAuthorIDs: [ID!]`
- `excludeCustomPostAuthorIDs: [ID]`
- `customPostTypes: [String!]`
- `dateFrom: Date`
- `dateTo: Date`
- `excludeAuthorIDs: [ID]`
- `excludeIDs: [ID!]`
- `id: ID`
- `ids: [ID!]`
- `parentID: ID!`
- `parentIDs: [ID!]`
- `excludeParentIDs: [ID]`
- `excludeIDs: [ID!]`
- `searchfor: String`
- `types: [String!]`

### Comment Mutations

- Support creating comments by non logged-in users

### Users

Fetch a user by different means:

- `Root.userByUsername: User`
- `Root.userByEmail: User` ("admin" field)

Created the "admin" version of field `users`, enabling to filter users by email:

- `Root.usersForAdmin: [User]!`
- `Root.userCountForAdmin: Int!`

Query properties for users:

- `User.nicename: String!`
- `User.nickname: String!`
- `User.locale: String!`
- `User.registeredDate: String!`

### User roles

Added utility fields to better operate with user roles:

- `User.roleNames: [String]!`
- `User.hasRole: Bool!`
- `User.hasAnyRole: Bool!`
- `User.hasCapability: Bool!`
- `User.hasAnyCapability: Bool!`

Added arguments `roles` and `excludeRoles` in field `Root.usersForAdmin` to filter by user roles.

### Categories

Fetch the children of a category:

- `PostCategory.childCategories: [PostCategory]!`
- `PostCategory.childCategoryNames: [String]!`
- `PostCategory.childCategoryCount: Int`

```graphql
{
  postCategories(limit:-1) {
    ...CatProps
    childCategories {
      ...CatProps
      childCategories {
        ...CatProps
      }
    }
  }
}

fragment CatProps on PostCategory {
  id
  name
  parentCategory {
    id
    name
  }
}
```

### Menus

Menus have been upgraded, adding the following fields:

- `Root.menus: [Menu]!`: list and filter the menus on the site
- `Root.menuCount: Int!`: count the list of menus
- `Root.menuByLocation: Menu`: fetch a menu by its location
- `Root.menuBySlug: Menu`: fetch a menu by its slug
- `Menu.name: String`: menu's name
- `Menu.slug: String`: menu's slug
- `Menu.count: Int`: number of items in the menu
- `Menu.locations: [String]!`: locations assigned to the menu
- `Menu.items: [MenuItem]!`: items for a menu
- `MenuItem.children: [MenuItem]!`: children items for a menu item

```graphql
{
  menus {
    id
    name
    slug
    count
    locations
    items {
      ...MenuItemProps
      children {
        ...MenuItemProps
        children {
          ...MenuItemProps
        }
      }
    }
  }
}

fragment MenuItemProps on MenuItem {
  alt
  classes
  description
  id
  objectID
  parentID
  target
  title
  url
}
```

### User avatar

Added type `UserAvatar`, and fields:

- `User.avatar: [UserAvatar]`: the user's avatar
- `UserAvatar.src: String!`: the avatar's URL
- `UserAvatar.size: Int!`: the avatar's size

```graphql
{
  users {
    id
    avatar(size: 150) {
      size
      src
    }
  }
}
```

### Field `urlPath`

Field `urlPath` has been added to several types:

- `Post.urlPath: String!`
- `Page.urlPath: String!`
- `PostCategory.urlPath: String!`
- `PostTag.urlPath: String!`
- `User.urlPath: String!`

For instance, if field `User.url` returns `"https://mysite.com/author/admin/"`, then field `User.urlPath` returns `"/author/admin/"`.

```graphql
{
  users {
    id
    urlPath
  }
}
```

### Media

Added field arguments to `Root.mediaItems: [Media]!` for filtering results.

Added media fields:

- `Root.imageSizeNames: [String]!` to retrieve the list of the available intermediate image size names
- `Root.mediaItemCount: Int!` to count the number of media items

Added the following fields for media items:

- `Media.srcSet: String`
- `Media.url: String!`
- `Media.localURLPath: String`
- `Media.slug: String!`
- `Media.title: String`
- `Media.caption: String`
- `Media.altText: String`
- `Media.description: String`
- `Media.date: String`
- `Media.mimeType: String`
- `Media.sizes: String`

```graphql
{
  imageSizeNames
  mediaItems(
    limit: 3,
    order: "title|desc",
    date_from: "2012-01-02"
  ) {
    id
    srcSet
    src(size:"medium")
    sizes(size:"medium")
    height
    width
    slug
    url
    urlPath
    title
    caption
    altText
    description
    date
    mimeType
  }
}
```

### Settings

Whitelist additional entries by default:

- `"siteurl"`
- `"WPLANG"`
- `"posts_per_page"`
- `"comments_per_page"`
- `"date_format"`
- `"time_format"`
- `"blog_charset"`

## Enable unsafe default settings

The GraphQL API for WordPress provides safe default settings:

- The single endpoint is disabled
- The "admin" fields (such as `postsForAdmin`, to fetch posts with status `"draft"`) are not added to the schema
- Only a handful of the settings options and meta keys (for posts, users, etc) can be queried
- The number of entities that can be queried at once is limited (for posts, users, etc)

These safe default settings are needed to make "live" sites secure, to prevent malicious attacks. However, they are not needed when building "static" sites, where the WordPress site is not exposed to the Internet.

Starting from `v0.9`, we can enable unsafe defaults by adding in `wp-config.php`:

```php
define( 'GRAPHQL_API_ENABLE_UNSAFE_DEFAULTS', true );
```

Alternatively, we can define this same key/value as an environment variable.

## Added module "Schema Self Fields"

This new module exposes a `self` field to all types in the GraphQL schema, which echoes back the same object where it is applied:

```graphql
type QueryRoot {
  self: QueryRoot!
}

type Post {
  self: Post!
}

type User {
  self: User!
}
```

This field can be used to give a particular shape to the GraphQL response.

## Schema Configuration for the Single Endpoint

Starting from `v0.9`, the GraphQL single endpoint can be assigned a Schema Configuration (similar to the custom endpoints).

This means we can now configure the single endpoint:

- Access control
- Cache control
- Nested mutations
- Schema namespacing
- Admin fields
- Self fields
- Public or private schema mode

To configure the single endpoint, go to tab "Schema Configuration" on the Settings page, and select the desired Schema Configuration entry from the dropdown for "Schema Configuration for the Single Endpoint", and click on "Save Changes":

<a href="../../images/settings-schema-configuration-for-single-endpoint.png" target="_blank">![Settings for the Schema Configuration for the Single Endpoint](../../images/settings-schema-configuration-for-single-endpoint.png)</a>

## Exposed the `__schema` introspection field in the ACLs

The `__schema` field is now exposed in the Access Control Lists:

<a href="../../images/schema-introspection-field-in-acl.png" target="_blank">![__schema field in the Access Control List](../../images/schema-introspection-field-in-acl.png)</a>

This allows us to disable introspection for the single endpoint or custom endpoints using access control rules, such as:

- Disable always
- Disable for logged-out users
- Disable for users with or without a certain role or capability

<a href="../../images/disabling-schema-introspection-field-in-acl.png" target="_blank">![Disabling the __schema field in the Access Control List](../../images/disabling-schema-introspection-field-in-acl.png)</a>

For instance, opening the GraphiQL client on a custom endpoint after disabling access to `__schema` we get an error:

> Uncaught (in promise) Error: Invalid or incomplete introspection result. Ensure that you are passing "data" property of introspection response and no "errors" was returned alongside: { __schema: null }

<a href="../../images/introspection-disabled-graphiql-error.png" target="_blank">![GraphiQL error from disabled introspection](../../images/introspection-disabled-graphiql-error.png)</a>

## Sort fields and connections together, alphabetically

When retrieving the GraphQL schema via introspection, all connections were shown first, and only then all fields.

Now, they are sorted all together, making it easier to browse the fields in the GraphiQL Docs Explorer.

## In the ACLs and CCLs, display fields for both the `Root` type, and the `QueryRoot`+`MutationRoot` types

When the "nested mutations" feature is enabled, the initial type in the GraphQL schema is `Root` (handling both queries and mutations). When this feature is disabled, the initial types are `QueryRoot` (to handle queries) and `MutationRoot` (to handle mutations).

When creating the Access Control Lists and Cache Control Lists, if the nested mutations feature was enabled and then we disable it (or vice versa), then the ACL/CCL configurations for fields from the root types would be broken, since that root type would be removed from the schema.

This has been fixed on `v0.9`. Now, the ACL and CCL configurations always display all 3 types:

- the `Root` type
- the `QueryRoot` + `MutationRoot` types

When using nested mutations, those entries under the `Root` will be used. When not, those entries under `QueryRoot` + `MutationRoot` will be used.

This means that we must be careful when selecting fields from the root types. To be on the safe side, we should select the field on the two possible root types:

- Query fields, select them under both `Root` and `QueryRoot` types
- Mutation fields, select them under both `Root` and `MutationRoot` types

For instance, mutation `addCommentToCustomPost` must be selected under both `Root` and `MutationRoot`:

<a href="../../images/releases/v09/select-field-from-two-types-in-acl.png" target="_blank">![Selecting the same field on the two possible root types](../../images/releases/v09/select-field-from-two-types-in-acl.png)</a>

## The entities from the WordPress data model are not namespaced anymore

The WordPress data model is considered canonical, then its GraphQL schema types (such as `Post` and `User`) and interfaces (such as `Commentable` and `WithMeta`) do not need be namespaced. If any plugin provides the same name for any of these entities, the plugin's namespacing will already differentiate among them.

For instance, type `Post` was namespaced as `PoPSchema_Posts_Post`. From `v0.9`, `Post` will always be `Post`, in both the namespaced and normal schemas.

If plugin "MyPlugin" also provides a type `Post`, then it will be namespaced as `MyCompany_MyPlugin_Post`, and that's enough to differentiate it from `Post`.

## Split Settings into "Default value for Schema Configuration" and "Value for the Admin"

The settings for several modules has been split into 2 separate items:

1. **Default value for Schema Configuration**: value to apply when the corresponding option in the Schema Configuration is set to `"Default"`
2. **Value for the Admin**: value to apply in the wp-admin, including the GraphiQL and Interactive Schema clients, and in the Access/Cache Control Lists.

This decoupling allows us to try out some functionality (such as nested mutations) in the wp-admin's GraphiQL and Interactive Schema clients first, and only later enable it for the exposed endpoints.

The updated modules are:

- Schema Namespacing
- Nested Mutations
- Schema Admin Fields

<a href="../../images/releases/v09/split-settings-into-2.png" target="_blank">![Selecting the same field on the two possible root types](../../images/releases/v09/split-settings-into-2.png)</a>

## Validate constraints for field and directive arguments

Resolvers for fields and directives can now validate constraints on the argument values.

For instance, if field `Root.posts` has a maximum limit of 100 items, and we execute the following query:

```graphql
{
  posts(limit: 150) {
    id
  }
}
```

... then we get an error:

```json
{
  "errors": [
    {
      "message": "The value for argument 'limit' in field 'posts' cannot be above '100'",
      "extensions": {
        "type": "QueryRoot",
        "field": "posts(limit:150)"
      }
    }
  ],
  "data": {
    "posts": null
  }
}
```

## Added options "default limit" and "max limit" for Posts and Pages

The Settings for Posts and Pages used the "default limit" and "max limit" values assigned in the tab for Custom Posts.

Now, they have their own:

<a href="../../images/releases/v09/posts-settings-new-options.png" target="_blank">![Default and max limit options for posts in the Settings page](../../images/releases/v09/posts-settings-new-options.png)</a>

## Performance improvement: Avoid regenerating the container when the schema is modified

When a Schema Configuration, Access Control List or Cache Control List is modified, the schema must be regenerated. This was done by purging the whole cache folder, which contains both the service container and the schema configuration files. However, since regenerating the service container takes a few seconds, we'd rather not purge that folder when there is no need to.

From `v0.9`, the service container and the schema both have independent timestamps tracking their state, and they can be purged independently. Hence, modifying the schema will only purge the corresponding cached files, and there will be an improvement in performance when editing any of the CPTs provided in the plugin.

## Clicking on "Save Changes" on the Settings page will always regenerate the schema

If we are testing an extension and the schema is cached, it must be purged. To do so, we can modify some value in the Settings page and save, which would regenerate the schema. But this required some value to be modified.

From `v0.9` it is not needed to modify any value on the Settings. Just clicking on the "Save Changes" button will always regenerate the schema.

## Prettyprint GraphQL queries in the module docs

The GraphQL queries in the module documentation are now prettyprinted:

<a href="../../images/releases/v09/prettyprinted-code.png" target="_blank">![Prettyprinted GraphQL queries in module docs](../../images/releases/v09/prettyprinted-code.png)</a>

## Fixed issues

- Fixed newlines removed from GraphQL query after refreshing browser ([#972](https://github.com/leoloso/PoP/pull/972))

## Breaking changes

### Renamed the "Schema Admin Fields"

Renamed module "Schema for the Admin" to "Schema Admin Fields". If this module had been disabled, it must be disabled again.

In addition, its block for the Schema Configuration also got renamed, so you must click on "Reset the template" on all Schema Configurations to show the block again:

<a href="../../images/releases/v09/schema-config-reset-the-template.png" target="_blank">![Click on "Reset the template" on all Schema Configurations](../../images/releases/v09/schema-config-reset-the-template.png)</a>

### Renamed the Admin fields

Renamed all the "admin" fields. Instead of prepending them with "unrestricted", now they are appended "ForAdmin":

Root:

- `unrestrictedPost` => `postForAdmin`
- `unrestrictedPosts` => `postsForAdmin`
- `unrestrictedPostCount` => `postCountForAdmin`
- `unrestrictedCustomPost` => `customPostForAdmin`
- `unrestrictedCustomPosts` => `customPostsForAdmin`
- `unrestrictedCustomPostCount` => `customPostCountForAdmin`
- `unrestrictedPage` => `pageForAdmin`
- `unrestrictedPages` => `pagesForAdmin`
- `unrestrictedPageCount` => `pageCountForAdmin`

User:

- `unrestrictedPosts` => `postsForAdmin`
- `unrestrictedPostCount` => `postCountForAdmin`
- `unrestrictedCustomPosts` => `customPostsForAdmin`
- `unrestrictedCustomPostCount` => `customPostCountForAdmin`

PostCategory:

- `unrestrictedPosts` => `postsForAdmin`
- `unrestrictedPostCount` => `postCountForAdmin`

PostTag:

- `unrestrictedPosts` => `postsForAdmin`
- `unrestrictedPostCount` => `postCountForAdmin`

### Broken entries in ACLs and CCLs, must be reconfigured

After updating to `v0.9`, the Access Control and Cache Control configuration lists will be broken: all fields for all non-root types broken will appear under "(Undefined entries)".

<a href="../../images/releases/v09/acl-undefined-entries.png" target="_blank">![Broken entries in Access Control List](../../images/releases/v09/acl-undefined-entries.png)</a>

The reason is that types and interfaces from the WordPress data model are not namespaced anymore, and the ACL/CCL entry uses the namespaced name to be stored in the DB (for instance, in the image above, entry `PoPSchema_Comments_Comment.authorEmail` is how `Comment.authorEmail` was stored... from now on, it will be stored as `Comment.authorEmail`).

To fix this, you will need to recreate these lists. Sorry about that.

### Settings for several modules must be set again

Those modules which had their Settings value split into 2 ("Default value for Schema Configuration" and "Value for the Admin") must be set again:

- Schema Namespacing
- Nested Mutations
- Schema Admin Fields

In addition, the `Default Schema Configuration` option for module "Schema Configuration" has been renamed, and it must also be set again.

<a href="../../images/releases/v09/renamed-option-set-again.png" target="_blank">![Must set again the value for Default Schema Configuration](../../images/releases/v09/renamed-option-set-again.png)</a>

### Must set options "default limit" and "max limit" for Posts and Pages

Posts and pages do not take their "default limit" and "max limit" values from the Custom Posts anymore. Now we must set their own values, under sections "Schema Posts" and "Schema Pages" in the Settings page.
